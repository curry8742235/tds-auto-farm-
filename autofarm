-- // CONFIGURATION 
getgenv().AutoStrat = true
getgenv().AutoSkip = true 
getgenv().AutoPickups = true
getgenv().Webhook = "" 

-- // 1. LOAD LIBRARY
local libURL = "https://gist.githubusercontent.com/curry8742235/38ad26d4b4b3373a9b7b21bf59d14015/raw/85d4d1a32dd0f37fb9e2766bcaf97480cdf121c7/library"
local success, TDS = pcall(function() return loadstring(game:HttpGet(libURL))() end)

if not success or not TDS then
    warn("Gist failed, using backup library...")
    TDS = loadstring(game:HttpGet("https://raw.githubusercontent.com/DuxiiT/auto-strat/refs/heads/main/Library.lua"))()
end

if not TDS then return warn("CRITICAL: Library failed to load.") end

-- // 2. SETUP AGGRESSIVE ADAPTATION
local Workspace = game:GetService("Workspace")
local RemoteFunc = game:GetService("ReplicatedStorage"):WaitForChild("RemoteFunction")
local LocalPlayer = game:GetService("Players").LocalPlayer

-- Get Map Anchor
local function GetMapAnchor()
    local map = Workspace:FindFirstChild("Map")
    if not map then return Vector3.zero end
    if map:FindFirstChild("EnemySpawn") then return map.EnemySpawn.Position end
    local paths = map:FindFirstChild("Paths")
    if paths then
        local targets = {"0", "1", "Path", "Path1"}
        for _, t in ipairs(targets) do
            local obj = paths:FindFirstChild(t)
            if obj then
                if obj:IsA("BasePart") then return obj.Position end
                if obj:IsA("Folder") or obj:IsA("Model") then
                    local p = obj:FindFirstChild("0") or obj:FindFirstChild("1") or obj:FindFirstChildWhichIsA("BasePart")
                    if p then return p.Position end
                end
            end
        end
    end
    return Vector3.zero
end

-- Raycast to find floor height
local function GetGroundY(x, z, anchorY)
    local origin = Vector3.new(x, anchorY + 150, z)
    local dir = Vector3.new(0, -400, 0)
    local params = RaycastParams.new()
    params.FilterType = Enum.RaycastFilterType.Exclude
    params.FilterDescendantsInstances = {LocalPlayer.Character, Workspace:FindFirstChild("Towers"), Workspace:FindFirstChild("Pickups"), Workspace:FindFirstChild("Camera")}

    local res = Workspace:Raycast(origin, dir, params)
    if res and res.Instance then
        -- Avoid placing ON TOP of paths if possible, but return the Y anyway
        -- We return the Y position + 0.1 to sit slightly above ground
        return res.Position.Y + 0.1, res.Instance
    end
    return nil
end

-- Calculate Global Offset
local RecAnchor = Vector3.new(-48.8, 3.8, 14.5)
local CurAnchor = GetMapAnchor()
local MapOffset = (CurAnchor.Magnitude > 0) and (CurAnchor - RecAnchor) or Vector3.zero
local RecBaseY = RecAnchor.Y

print("[DeepSeek] Global Map Offset:", MapOffset)

-- // 3. AGGRESSIVE PLACE FUNCTION
TDS.Place = function(self, name, recX, recY, recZ)
    local baseX = recX + MapOffset.X
    local baseZ = recZ + MapOffset.Z
    
    -- Estimated Height (Blind Fallback)
    local relativeY = recY - RecBaseY
    local estimatedY = CurAnchor.Y + relativeY

    -- SEARCH PATTERN: Spiral out to 15 studs
    local offsets = { Vector3.new(0,0,0) } -- Start exact
    for r=2, 15, 2.5 do -- Radius steps
        for theta=0, 360, 45 do -- Angle steps
            local rad = math.rad(theta)
            table.insert(offsets, Vector3.new(math.cos(rad)*r, 0, math.sin(rad)*r))
        end
    end

    for i, off in ipairs(offsets) do
        local tryX = baseX + off.X
        local tryZ = baseZ + off.Z
        
        -- Try to get exact ground height
        local groundY, hitPart = GetGroundY(tryX, tryZ, CurAnchor.Y)
        local placeY = groundY or estimatedY -- Use Raycast Y, fallback to Math Y
        
        -- Logic: If we hit a path, skip this attempt unless we are desperate (Radius > 10)
        local isPath = hitPart and (hitPart.Name == "Path" or hitPart.Parent.Name == "Paths")
        if not isPath or off.Magnitude > 10 then 
            
            -- ATTEMPT PLACEMENT
            local success, res = pcall(function()
                return RemoteFunc:InvokeServer("Troops", "Place", {
                    Rotation = CFrame.new(),
                    Position = Vector3.new(tryX, placeY, tryZ)
                }, name)
            end)

            -- VERIFY SUCCESS
            if success and (res == true or (type(res)=="table" and res.Success)) then
                -- Wait for tower to replicate
                local timeout = tick() + 2
                repeat task.wait(0.05) until tick() > timeout or #Workspace.Towers:GetChildren() > #self.placed_towers
                
                -- Find the new tower
                local found = false
                for _, t in ipairs(Workspace.Towers:GetChildren()) do
                    if t.Name == name and t:FindFirstChild("Owner") and t.Owner.Value == LocalPlayer.UserId then
                        -- Check if we already tracked this specific instance
                        local isNew = true
                        for _, existing in ipairs(self.placed_towers) do
                            if existing == t then isNew = false break end
                        end
                        
                        if isNew then
                            table.insert(self.placed_towers, t)
                            print("✅ PLACED", name, "| Offset:", off.Magnitude, "studs")
                            return -- SUCCESS! Exit function
                        end
                    end
                end
            end
        end
    end
    
    warn("❌ COMPLETELY FAILED to place", name, "- Skipping")
end

print("--- AGGRESSIVE STRAT LOADED ---")

-- // 4. EXECUTE STRATEGY
-- (Units below)
TDS:Place("Scout", -18.16, 1.00, -2.36)
TDS:Place("Scout", -18.17, 1.00, -5.55)
TDS:Place("Scout", -18.19, 1.00, -8.74)
TDS:Place("Scout", -14.89, 1.00, -9.23)
TDS:Place("Scout", -17.18, 1.00, -11.71)
TDS:Place("Scout", -19.92, 1.00, -13.37)
TDS:Place("Scout", -17.09, 1.00, -14.89)
TDS:Place("Scout", -14.19, 1.00, -12.89)
TDS:Place("Scout", -11.89, 1.00, -10.53)
TDS:Place("Scout", -11.78, 1.00, -3.17)
TDS:Place("Scout", -8.58, 1.00, -2.99)
TDS:Place("Scout", -11.85, 1.00, 0.04)
TDS:Place("Scout", -8.53, 1.00, 0.17)
TDS:Place("Scout", -11.81, 1.00, 3.27)
TDS:Place("Scout", -8.53, 1.00, 3.45)
TDS:Place("Scout", -14.97, 1.00, 3.62)
TDS:Place("Scout", -18.32, 1.00, 3.66)
TDS:Place("Scout", -21.56, 1.00, 3.69)
TDS:Place("Scout", -21.55, 1.00, 7.07)
TDS:Place("Scout", -18.18, 1.00, 7.07)
TDS:Place("Scout", -14.82, 1.00, 6.91)
TDS:Place("Scout", -11.70, 1.00, 6.73)
TDS:Place("Scout", -8.36, 1.00, 6.84)
TDS:Place("Scout", -5.36, 1.00, -3.08)
TDS:Place("Scout", -8.55, 1.00, -9.23)
TDS:Place("Scout", -4.77, 1.00, -9.17)
TDS:Place("Scout", -2.12, 1.00, -3.02)
TDS:Place("Scout", -1.53, 1.00, -9.31)
TDS:Place("Scout", -24.45, 1.00, -5.66)
TDS:Place("Scout", -24.49, 1.00, -2.38)
TDS:Place("Scout", -24.47, 1.00, 1.04)
TDS:Place("Scout", -24.80, 1.00, 4.40)
TDS:Place("Scout", -27.41, 1.00, -7.94)
TDS:Place("Scout", -27.25, 1.00, -11.07)
TDS:Place("Scout", -1.83, 1.00, 3.27)
TDS:Place("Scout", 1.25, 1.00, -3.35)
TDS:Place("Scout", 4.46, 1.00, -3.42)
TDS:Place("Scout", 1.42, 1.00, 3.43)
TDS:Place("Scout", 5.39, 1.00, 3.24)
TDS:Place("Scout", 6.56, 1.00, -7.08)

-- Max Upgrade
for lvl = 1, 4 do
    for i = 1, 40 do TDS:Upgrade(i) end
    task.wait(1.5)
end
